import argparse
import os
import cv2
import time
import numpy as np
from src.denoiser import AdaptiveWeightedLSQ
from src.utils import add_salt_pepper_noise, noise_detection
from src.metrics import get_all_metrics

def main():
    parser = argparse.ArgumentParser(description="AWLF Denoiser Benchmark")
    parser.add_argument('--image', type=str, required=True, help="Path to clean image")
    parser.add_argument('--output', type=str, default="results", help="Output directory")
    args = parser.parse_args()

    os.makedirs(args.output, exist_ok=True)
    
    # Load Image
    clean_img = cv2.imread(args.image, cv2.IMREAD_GRAYSCALE)
    if clean_img is None:
        print("Error: Could not load image.")
        return

    # Benchmark Configuration
    densities = [0.2, 0.4, 0.8]
    denoiser = AdaptiveWeightedLSQ()

    print(f"{'Density':<10} {'PSNR':<10} {'SSIM':<10} {'FSIM':<10} {'Time':<10}")
    print("-" * 55)

    for d in densities:
        # 1. Add Noise
        noisy, real_mask = add_salt_pepper_noise(clean_img, density=d, seed=42)
        
        # 2. Detect Noise
        detected_mask = noise_detection(noisy)
        
        # 3. Denoise
        start = time.time()
        restored = denoiser.denoise(noisy, detected_mask)
        elapsed = time.time() - start
        
        # 4. Metrics
        psnr, s_score, fsim = get_all_metrics(clean_img, restored)
        
        print(f"{d:<10.0%} {psnr:<10.2f} {s_score:<10.4f} {fsim:<10.2f} {elapsed:<10.1f}s")
        
        # Save
        cv2.imwrite(os.path.join(args.output, f"denoised_{int(d*100)}.png"), restored)
        cv2.imwrite(os.path.join(args.output, f"noisy_{int(d*100)}.png"), noisy)

if __name__ == "__main__":
    main()
